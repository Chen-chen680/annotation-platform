<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能数据标注平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0,0,0,0.2);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }
        
        .content {
            padding: 30px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 项目管理页面样式 */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .project-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .project-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .project-description {
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .project-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #6c757d;
        }
        
        .project-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-bar-small {
            width: 60px;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill-small {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .create-project-card {
            border: 2px dashed #dee2e6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #6c757d;
            background: #f8f9fa;
        }
        
        .create-project-card:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f0f3ff;
        }
        
        .create-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        /* 表单样式 */
        .form-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-control {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
        }
        
        .btn-outline:hover {
            background: #667eea;
            color: white;
        }
        
        /* 预览数据样式 */
        .preview-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
            margin-top: 20px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e9ecef;
            position: relative;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .editable-header {
            background: none;
            border: none;
            font-weight: 600;
            color: #495057;
            width: 100%;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .editable-header:focus {
            outline: none;
            background: #fff;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }
        
        /* 标注配置样式 */
        .annotation-configs {
            display: grid;
            gap: 20px;
        }
        
        .annotation-config-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .config-title {
            font-weight: 600;
            color: #495057;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        /* 数据表格样式 */
        .data-table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
            overflow: hidden;
        }
        
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            table-layout: fixed;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: top;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        /* URL链接样式 */
        .url-link {
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .url-link:hover {
            color: #5a67d8;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* 列宽度控制 */
        .column-width-input {
            width: 80px;
            text-align: center;
        }
        
        /* 预览表格样式 */
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            table-layout: fixed;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e9ecef;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .annotation-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .annotation-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .annotation-label {
            display: block;
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            background: #f8f9fa;
            color: #495057;
        }
        
        /* 统计卡片样式 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* 面包屑导航 */
        .breadcrumb {
            background: #f8f9fa;
            padding: 10px 30px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
            color: #6c757d;
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        /* 项目搜索和筛选 */
        .project-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            padding: 8px 20px;
            transition: border-color 0.3s ease;
            min-width: 300px;
        }
        
        .search-box:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-box input {
            border: none;
            outline: none;
            flex: 1;
            background: transparent;
            font-size: 14px;
        }
        
        .search-box .search-icon {
            color: #6c757d;
            margin-right: 10px;
        }
        
        /* 项目卡片优化 */
        .project-card {
            position: relative;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .project-card-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .project-card:hover .project-card-actions {
            opacity: 1;
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            color: #6c757d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .action-btn:hover {
            transform: scale(1.1);
            color: white;
        }
        
        .action-btn.edit:hover { background: #28a745; }
        .action-btn.delete:hover { background: #dc3545; }
        .action-btn.copy:hover { background: #17a2b8; }
        
        /* 文件上传区域优化 */
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .upload-area.has-file {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }
        
        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 15px;
            transition: color 0.3s ease;
        }
        
        .upload-area.dragover .upload-icon {
            color: #667eea;
        }
        
        .file-info {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
        }
        
        .file-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        /* 配置向导样式 */
        .config-wizard {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .wizard-step {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background: #f8f9fa;
            color: #6c757d;
            border-radius: 25px;
            margin: 0 10px;
            font-weight: 500;
            position: relative;
        }
        
        .wizard-step.active {
            background: #667eea;
            color: white;
        }
        
        .wizard-step.completed {
            background: #28a745;
            color: white;
        }
        
        .wizard-step:not(:last-child)::after {
            content: '→';
            position: absolute;
            right: -25px;
            color: #6c757d;
        }
        
        /* 快捷操作工具栏 */
        .toolbar {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .keyboard-shortcuts {
            font-size: 12px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 15px;
        }
        
        /* 加载状态 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            font-size: 16px;
            margin-top: 20px;
            text-align: center;
        }
        
        /* 操作反馈提示 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error {
            background: #dc3545;
        }
        
        .toast.warning {
            background: #ffc107;
            color: #333;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .content { padding: 15px; }
            .project-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .table-controls { flex-direction: column; align-items: stretch; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="pageTitle">🎯 智能数据标注平台</h1>
            <p id="pageSubtitle">基于项目管理的高效数据标注解决方案</p>
        </div>
        
        <!-- 面包屑导航 -->
        <div class="breadcrumb" id="breadcrumb">
            <a href="#" onclick="backToProjects()">项目管理</a>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('projects', this)">📁 项目管理</button>
            <button class="nav-tab" onclick="switchTab('upload', this)" id="uploadTab" style="display:none;">📤 数据上传</button>
            <button class="nav-tab" onclick="switchTab('annotate', this)" id="annotateTab" style="display:none;">✏️ 数据标注</button>
            <button class="nav-tab" onclick="switchTab('export', this)" id="exportTab" style="display:none;">📊 导出分析</button>
        </div>
        
        <div class="content">
            <!-- 项目管理页面 -->
            <div id="projects" class="tab-content active">
                <div class="project-controls">
                    <div class="search-box">
                        <span class="search-icon">🔍</span>
                        <input type="text" placeholder="搜索项目..." id="projectSearch" onkeyup="searchProjects()">
                    </div>
                    <div>
                        <select class="form-control" id="projectSort" onchange="sortProjects()" style="width: 200px;">
                            <option value="updated_desc">最近更新</option>
                            <option value="created_desc">创建时间</option>
                            <option value="name_asc">名称 A-Z</option>
                            <option value="progress_desc">完成度</option>
                        </select>
                    </div>
                </div>
                
                <div class="section-title">我的项目 (<span id="projectCount">0</span>)</div>
                <div class="project-grid" id="projectGrid">
                    <div class="project-card create-project-card" onclick="showCreateProjectModal()">
                        <div class="create-icon">➕</div>
                        <div>创建新项目</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                            支持CSV、TSV、TXT格式
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据上传页面 -->
            <div id="upload" class="tab-content">
                <div class="config-wizard">
                    <div class="wizard-step active" id="step1">1. 选择文件</div>
                    <div class="wizard-step" id="step2">2. 预览数据</div>
                    <div class="wizard-step" id="step3">3. 配置列</div>
                    <div class="wizard-step" id="step4">4. 开始标注</div>
                </div>
                
                <div class="form-section">
                    <div class="section-title">
                        上传数据文件
                        <div style="float: right;">
                            <button class="btn btn-secondary" onclick="showReplaceFileModal()" id="replaceFileBtn" style="display: none;">
                                🔄 替换文件
                            </button>
                        </div>
                    </div>
                    
                    <div class="toolbar">
                        <div class="toolbar-group">
                            <label class="form-label">上传方式：</label>
                            <select class="form-control" id="uploadType" onchange="toggleUploadMethod()" style="width: 150px;">
                                <option value="file">本地文件</option>
                                <option value="url">URL下载</option>
                                <option value="ftp">FTP下载</option>
                            </select>
                        </div>
                        
                        <div class="toolbar-group">
                            <label class="form-label">分隔符：</label>
                            <select class="form-control" id="delimiter" onchange="toggleCustomDelimiter()" style="width: 120px;">
                                <option value=",">逗号 (,)</option>
                                <option value="\t">制表符 (\t)</option>
                                <option value="|">竖线 (|)</option>
                                <option value=";">分号 (;)</option>
                                <option value="custom">自定义</option>
                            </select>
                        </div>
                        
                        <div class="toolbar-group">
                            <label class="form-label">编码：</label>
                            <select class="form-control" id="encoding" style="width: 120px;">
                                <option value="utf-8">UTF-8</option>
                                <option value="gbk">GBK</option>
                                <option value="gb2312">GB2312</option>
                                <option value="iso-8859-1">ISO-8859-1</option>
                                <option value="auto">自动检测</option>
                            </select>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="hasHeader">
                            <label for="hasHeader">包含表头</label>
                        </div>
                    </div>
                    
                    <div id="customDelimiterGroup" style="display:none; margin-bottom: 20px;">
                        <label class="form-label">自定义分隔符：</label>
                        <input type="text" class="form-control" id="customDelimiter" placeholder="输入分隔符" style="width: 200px;">
                    </div>
                    
                    <!-- 文件上传区域 -->
                    <div id="fileUpload">
                        <div class="upload-area" id="uploadArea" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <div class="upload-icon" id="uploadIcon">📁</div>
                            <h3 id="uploadTitle">拖拽文件到这里或点击选择</h3>
                            <p id="uploadSubtitle">支持 CSV、TSV、TXT 格式文件</p>
                            <input type="file" id="dataFile" accept=".csv,.tsv,.txt" onchange="handleFileSelect(event)" style="display: none;">
                            <button class="btn btn-outline" onclick="document.getElementById('dataFile').click()">选择文件</button>
                        </div>
                        
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <h4>📄 文件信息</h4>
                            <div class="file-info-item">
                                <span>文件名:</span>
                                <span id="fileName"></span>
                            </div>
                            <div class="file-info-item">
                                <span>文件大小:</span>
                                <span id="fileSize"></span>
                            </div>
                            <div class="file-info-item">
                                <span>最后修改:</span>
                                <span id="fileDate"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="urlUpload" style="display:none;">
                        <label class="form-label">文件URL：</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" class="form-control" id="dataUrl" placeholder="https://example.com/data.csv" style="flex: 1;">
                            <button class="btn btn-outline" onclick="testUrl()">测试连接</button>
                        </div>
                    </div>
                    
                    <div id="ftpUpload" style="display:none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">FTP服务器：</label>
                                <input type="text" class="form-control" id="ftpServer" placeholder="ftp.example.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">文件路径：</label>
                                <input type="text" class="form-control" id="ftpPath" placeholder="/path/to/file.csv">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">用户名：</label>
                                <input type="text" class="form-control" id="ftpUser">
                            </div>
                            <div class="form-group">
                                <label class="form-label">密码：</label>
                                <input type="password" class="form-control" id="ftpPassword">
                            </div>
                        </div>
                        <button class="btn btn-outline" onclick="testFtpConnection()">测试连接</button>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="uploadData()" id="uploadBtn">
                            📤 上传并解析
                        </button>
                    </div>
                </div>
                
                <div id="previewSection" style="display:none;" class="preview-section">
                    <div class="section-title">
                        数据预览（前3行）
                        <div class="keyboard-shortcuts">提示：双击表头可编辑列名</div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="preview-table" id="previewTable">
                            <thead id="previewTableHead"></thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="proceedToConfig()">✅ 继续配置</button>
                    </div>
                </div>
                
                <div id="annotationConfigSection" style="display:none;" class="form-section">
                    <div class="section-title">配置数据列和标注项</div>
                    <div class="annotation-configs" id="annotationConfigs"></div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-outline" onclick="addAnnotationConfig()">➕ 添加标注项</button>
                        <button class="btn btn-success" onclick="saveAnnotationConfig()" style="margin-left: 15px;">💾 保存配置并开始标注</button>
                    </div>
                </div>
            </div>
            
            <!-- 数据标注页面 -->
            <div id="annotate" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-group">
                        <label class="form-label">每页显示：</label>
                        <select class="form-control" id="pageSize" onchange="changePageSize()" style="width: 80px;">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span>条</span>
                    </div>
                    
                    <div class="toolbar-group">
                        <span id="paginationInfo">第 1 页，共 1 页</span>
                        <button class="btn btn-outline" onclick="previousPage()">上一页</button>
                        <button class="btn btn-outline" onclick="nextPage()">下一页</button>
                    </div>
                    
                    <div class="toolbar-group">
                        <button class="btn btn-outline" onclick="toggleColumnsModal()">显示列设置</button>
                        <button class="btn btn-outline" onclick="batchAnnotate()">批量标注</button>
                        <div class="keyboard-shortcuts">快捷键: Ctrl+S 保存</div>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-wrapper">
                        <table class="data-table" id="dataTable">
                            <thead id="dataTableHead"></thead>
                            <tbody id="dataTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="toolbar" style="justify-content: center;">
                    <button class="btn btn-primary" onclick="exportAnnotations()">导出当前页</button>
                    <button class="btn btn-success" onclick="switchTab('export', this)">查看完整统计</button>
                </div>
            </div>
            
            <!-- 导出分析页面 -->
            <div id="export" class="tab-content">
                <div class="stats-grid" id="statsGrid"></div>
                
                <div class="form-section">
                    <div class="section-title">导出设置</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">导出格式：</label>
                            <select class="form-control" id="exportFormat">
                                <option value="csv">CSV</option>
                                <option value="excel">Excel (XLSX)</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeOriginal" checked>
                            <label for="includeOriginal">包含原始数据</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeAnnotations" checked>
                            <label for="includeAnnotations">包含标注结果</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeStats">
                            <label for="includeStats">包含统计信息</label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="exportData()">📥 导出数据</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 创建项目模态框 -->
    <div id="createProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>创建新项目</h3>
                <button class="close-modal" onclick="closeModal('createProjectModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">项目名称：</label>
                <input type="text" class="form-control" id="projectName" placeholder="请输入项目名称">
            </div>
            <div class="form-group">
                <label class="form-label">项目描述：</label>
                <textarea class="form-control" id="projectDescription" rows="3" placeholder="请输入项目描述"></textarea>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('createProjectModal')">取消</button>
                <button class="btn btn-primary" onclick="createProject()" style="margin-left: 10px;">创建</button>
            </div>
        </div>
    </div>
    
    <!-- 搜索结果模态框 -->
    <div id="searchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>搜索结果</h3>
                <button class="close-modal" onclick="closeModal('searchModal')">&times;</button>
            </div>
            <div id="searchResults"></div>
        </div>
    </div>
    
    <!-- 自动保存指示器 -->
    <div id="autosaveIndicator" class="autosave-indicator">
        自动保存已开启
    </div>
    
    <script>
        // 全局变量
        const API_BASE = 'http://localhost:5000';  // API基础路径，根据实际部署修改
        let currentProject = null;
        let currentPage = 1;
        let pageSize = 20;
        let totalPages = 1;
        let annotationConfigs = [];
        let columnConfigs = [];
        let previewData = [];
        let autosaveInterval = null;
        let allProjects = []; // 存储所有项目数据用于搜索和排序
        let deleteProjectId = null; // 待删除的项目ID
        
        // 工具函数
        function showLoading(text = '处理中...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = path;
        }
        
        function updatePageTitle(title, subtitle = '') {
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('pageSubtitle').textContent = subtitle;
        }
        
        function updateWizardStep(step) {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (stepEl) {
                    stepEl.classList.remove('active', 'completed');
                    if (i < step) {
                        stepEl.classList.add('completed');
                    } else if (i === step) {
                        stepEl.classList.add('active');
                    }
                }
            }
        }
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            startAutoSave();
            showAutosaveIndicator();
            
            // 键盘快捷键
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (currentProject) {
                        showToast('数据已自动保存');
                    }
                }
            });
        });
        
        // 项目管理功能
        function loadProjects() {
            showLoading('加载项目列表...');
            
            fetch(`${API_BASE}/api/projects`)
                .then(response => response.json())
                .then(projects => {
                    allProjects = projects;
                    displayProjects(projects);
                    updateProjectCount(projects.length);
                    hideLoading();
                })
                .catch(error => {
                    console.error('加载项目失败:', error);
                    showToast('加载项目失败，请检查网络连接', 'error');
                    hideLoading();
                });
        }
        
        function displayProjects(projects) {
            const grid = document.getElementById('projectGrid');
            const createCard = grid.querySelector('.create-project-card');
            grid.innerHTML = '';
            grid.appendChild(createCard);
            
            projects.forEach(project => {
                const projectCard = createProjectCard(project);
                grid.appendChild(projectCard);
            });
        }
        
        function createProjectCard(project) {
            const div = document.createElement('div');
            div.className = 'project-card';
            div.onclick = () => openProject(project.id);
            
            div.innerHTML = `
                <div class="project-card-actions">
                    <button class="action-btn edit" onclick="event.stopPropagation(); editProject('${project.id}')" title="编辑项目">
                        ✏
                    </button>
                    <button class="action-btn delete" onclick="event.stopPropagation(); showDeleteProject('${project.id}', '${project.name}')" title="删除项目">
                        ✗
                    </button>
                </div>
                <div class="project-title">${project.name}</div>
                <div class="project-description">${project.description || '暂无描述'}</div>
                <div class="project-stats">
                    <span>数据量: ${project.data_count}</span>
                    <div class="project-progress">
                        <span>${project.completion_rate}%</span>
                        <div class="progress-bar-small">
                            <div class="progress-fill-small" style="width: ${project.completion_rate}%"></div>
                        </div>
                    </div>
                </div>
                <div style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                    最后更新: ${new Date(project.updated_at).toLocaleString()}
                </div>
            `;
            
            return div;
        }
        
        function searchProjects() {
            const searchTerm = document.getElementById('projectSearch').value.toLowerCase();
            const filtered = allProjects.filter(project => 
                project.name.toLowerCase().includes(searchTerm) ||
                (project.description && project.description.toLowerCase().includes(searchTerm))
            );
            displayProjects(filtered);
            updateProjectCount(filtered.length);
        }
        
        function sortProjects() {
            const sortBy = document.getElementById('projectSort').value;
            let sorted = [...allProjects];
            
            switch(sortBy) {
                case 'name_asc':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'created_desc':
                    sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'progress_desc':
                    sorted.sort((a, b) => b.completion_rate - a.completion_rate);
                    break;
                case 'updated_desc':
                default:
                    sorted.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                    break;
            }
            
            allProjects = sorted;
            searchProjects(); // 应用当前搜索条件
        }
        
        function updateProjectCount(count) {
            document.getElementById('projectCount').textContent = count;
        }
        
        function showDeleteProject(projectId, projectName) {
            deleteProjectId = projectId;
            document.getElementById('deleteProjectName').textContent = projectName;
            document.getElementById('deleteProjectModal').classList.add('active');
        }
        
        // 显示自动保存指示器
        function showAutosaveIndicator() {
            const indicator = document.getElementById('autosaveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => indicator.style.display = 'none', 3000);
        }
        
        // 开始自动保存
        function startAutoSave() {
            if (autosaveInterval) clearInterval(autosaveInterval);
            autosaveInterval = setInterval(() => {
                if (currentProject) {
                    const indicator = document.getElementById('autosaveIndicator');
                    indicator.textContent = '正在自动保存...';
                    indicator.style.background = '#ffc107';
                    indicator.style.color = '#333';
                    indicator.style.display = 'block';
                    
                    setTimeout(() => {
                        indicator.textContent = '自动保存完成';
                        indicator.style.background = '#28a745';
                        indicator.style.color = 'white';
                        setTimeout(() => indicator.style.display = 'none', 2000);
                    }, 1000);
                }
            }, 30000);
        }
        
        // 切换标签页
        function switchTab(tabName, element = null) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const targetTab = element || document.querySelector(`[onclick*="'${tabName}'"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'export') {
                loadStatistics();
            }
        }
        
        // 加载项目列表
        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/api/projects`);
                const projects = await response.json();
                
                const grid = document.getElementById('projectGrid');
                const createCard = grid.querySelector('.create-project-card');
                grid.innerHTML = '';
                grid.appendChild(createCard);
                
                projects.forEach(project => {
                    const projectCard = createProjectCard(project);
                    grid.appendChild(projectCard);
                });
            } catch (error) {
                console.error('加载项目失败:', error);
                showToast('加载项目失败，请检查网络连接', 'error');
            }
        }
        
        // 上传数据 - 增强版本
        async function uploadData() {
            if (!currentProject) {
                showToast('请先选择项目', 'warning');
                return;
            }
            
            updateWizardStep(1);
            showLoading('上传文件中...');
            
            const formData = new FormData();
            const uploadType = document.getElementById('uploadType').value;
            
            formData.append('upload_type', uploadType);
            formData.append('delimiter', document.getElementById('delimiter').value === 'custom' 
                ? document.getElementById('customDelimiter').value 
                : document.getElementById('delimiter').value);
            formData.append('encoding', document.getElementById('encoding').value);
            formData.append('has_header', document.getElementById('hasHeader').checked);
            
            if (uploadType === 'file') {
                const file = document.getElementById('dataFile').files[0];
                if (!file) {
                    hideLoading();
                    showToast('请选择文件', 'warning');
                    return;
                }
                formData.append('file', file);
            } else if (uploadType === 'url') {
                formData.append('url', document.getElementById('dataUrl').value);
            } else if (uploadType === 'ftp') {
                formData.append('ftp_server', document.getElementById('ftpServer').value);
                formData.append('ftp_user', document.getElementById('ftpUser').value);
                formData.append('ftp_password', document.getElementById('ftpPassword').value);
                formData.append('ftp_path', document.getElementById('ftpPath').value);
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/projects/${currentProject.id}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                hideLoading();
                
                if (response.ok) {
                    previewData = result.preview_data;
                    displayPreviewData(result.headers, result.preview_data);
                    updateWizardStep(2);
                    showToast(`上传成功！共解析 ${result.total_rows} 行数据`);
                    
                    // 显示替换文件按钮
                    document.getElementById('replaceFileBtn').style.display = 'block';
                } else {
                    showToast(result.error || '上传失败', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('上传失败:', error);
                showToast('上传失败，请检查网络连接', 'error');
            }
        }
        
        // 保存标注配置 - 增强版本
        async function saveAnnotationConfig() {
            if (!currentProject) {
                showToast('请先选择项目', 'warning');
                return;
            }
            
            updateWizardStep(3);
            showLoading('保存配置中...');
            
            try {
                const headers = Object.keys(previewData[0] || {});
                const columnConfigs = headers.map((header, index) => ({
                    original_name: header,
                    display_name: header,
                    is_visible: document.getElementById(`visible_${index}`)?.checked || true,
                    is_url: document.getElementById(`isUrl_${index}`)?.checked || false,
                    url_new_window: document.getElementById(`urlNewWindow_${index}`)?.checked || true,
                    column_width: parseInt(document.getElementById(`width_${index}`)?.value) || 150,
                    is_searchable: document.getElementById(`searchable_${index}`)?.checked || false,
                    search_api: document.getElementById(`searchApi_${index}`)?.querySelector('input')?.value || ''
                }));
                
                const annotationConfigsList = [];
                for (const configId of annotationConfigs) {
                    const fieldName = document.getElementById(`${configId}_fieldName`)?.value.trim();
                    if (!fieldName) {
                        hideLoading();
                        showToast('请填写所有标注项的字段名称', 'warning');
                        return;
                    }
                    
                    const config = {
                        fieldName,
                        labelText: document.getElementById(`${configId}_labelText`)?.value || '',
                        inputType: document.getElementById(`${configId}_inputType`)?.value || 'text',
                        minValue: document.getElementById(`${configId}_minValue`)?.value || '',
                        maxValue: document.getElementById(`${configId}_maxValue`)?.value || '',
                        options: document.getElementById(`${configId}_options`)?.value.split('\n').filter(opt => opt.trim()) || [],
                        isSearchable: document.getElementById(`${configId}_isSearchable`)?.checked || false,
                        searchApi: document.getElementById(`${configId}_searchApi`)?.value || ''
                    };
                    
                    annotationConfigsList.push(config);
                }
                
                const columnResponse = await fetch(`${API_BASE}/api/projects/${currentProject.id}/columns`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ columns: columnConfigs })
                });
                
                if (!columnResponse.ok) {
                    const error = await columnResponse.json();
                    throw new Error(error.message || '列配置保存失败');
                }
                
                const configResponse = await fetch(`${API_BASE}/api/projects/${currentProject.id}/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        annotation_configs: annotationConfigsList,
                        column_configs: columnConfigs
                    })
                });
                
                if (!configResponse.ok) {
                    const error = await configResponse.json();
                    throw new Error(error.message || '标注配置保存失败');
                }
                
                hideLoading();
                updateWizardStep(4);
                showToast('配置保存成功');
                switchTab('annotate');
                loadAnnotationData();
                
            } catch (error) {
                hideLoading();
                console.error('保存配置失败:', error);
                showToast(`保存配置失败: ${error.message}`, 'error');
            }
        }
        
        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // 点击模态框背景关闭
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
        
        // 导航功能
        function backToProjects() {
            currentProject = null;
            
            // 隐藏项目相关标签
            document.getElementById('uploadTab').style.display = 'none';
            document.getElementById('annotateTab').style.display = 'none';
            document.getElementById('exportTab').style.display = 'none';
            
            // 重置页面标题和面包屑
            updatePageTitle('智能数据标注平台', '基于项目管理的高效数据标注解决方案');
            updateBreadcrumb('<a href="#" onclick="backToProjects()">项目管理</a>');
            
            // 切换到项目页面
            switchTab('projects');
            
            // 重新加载项目列表
            loadProjects();
        }
        
        // 文件上传增强功能
        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
        }
        
        function handleFileDrop(e) {
            e.preventDefault();
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (isValidFile(file)) {
                    document.getElementById('dataFile').files = files;
                    displayFileInfo(file);
                } else {
                    showToast('请选择有效的文件格式 (CSV, TSV, TXT)', 'error');
                }
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                displayFileInfo(file);
            }
        }
        
        function isValidFile(file) {
            const validExtensions = ['csv', 'tsv', 'txt'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            return validExtensions.includes(fileExtension);
        }
        
        function displayFileInfo(file) {
            const uploadArea = document.getElementById('uploadArea');
            const fileInfo = document.getElementById('fileInfo');
            
            uploadArea.classList.add('has-file');
            document.getElementById('uploadIcon').textContent = '📄';
            document.getElementById('uploadTitle').textContent = '文件已选择';
            document.getElementById('uploadSubtitle').textContent = '点击"上传并解析"开始处理';
            
            // 显示文件信息
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileDate').textContent = new Date(file.lastModified).toLocaleString();
            fileInfo.style.display = 'block';
            
            // 启用上传按钮
            document.getElementById('uploadBtn').disabled = false;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function testUrl() {
            const url = document.getElementById('dataUrl').value;
            if (!url) {
                showToast('请输入URL地址', 'warning');
                return;
            }
            
            showLoading('测试连接中...');
            
            fetch(url, { method: 'HEAD' })
                .then(response => {
                    hideLoading();
                    if (response.ok) {
                        showToast('连接测试成功');
                    } else {
                        showToast('连接失败，请检查URL是否正确', 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showToast('连接测试失败，请检查网络或URL', 'error');
                });
        }
        
        function testFtpConnection() {
            const server = document.getElementById('ftpServer').value;
            const user = document.getElementById('ftpUser').value;
            
            if (!server || !user) {
                showToast('请填写FTP服务器和用户名', 'warning');
                return;
            }
            
            showToast('FTP连接测试功能需要后端支持', 'warning');
        }
        
        // 配置向导功能
        function proceedToConfig() {
            updateWizardStep(3);
            
            // 滚动到配置区域
            document.getElementById('annotationConfigSection').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }
        
        // 替换文件功能
        function showReplaceFileModal() {
            if (!currentProject) {
                showToast('请先选择项目', 'warning');
                return;
            }
            document.getElementById('replaceFileModal').classList.add('active');
        }
        
        function confirmReplaceFile() {
            const file = document.getElementById('replaceDataFile').files[0];
            if (!file) {
                showToast('请选择要替换的文件', 'warning');
                return;
            }
            
            if (!isValidFile(file)) {
                showToast('请选择有效的文件格式', 'error');
                return;
            }
            
            showLoading('替换文件中...');
            
            const formData = new FormData();
            formData.append('upload_type', 'file');
            formData.append('file', file);
            formData.append('delimiter', document.getElementById('delimiter').value);
            formData.append('encoding', document.getElementById('encoding').value);
            formData.append('has_header', document.getElementById('hasHeader').checked);
            
            fetch(`${API_BASE}/api/projects/${currentProject.id}/replace-file`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                hideLoading();
                if (result.message) {
                    showToast(`文件替换成功! 保留了${result.configs_preserved}个列配置`);
                    closeModal('replaceFileModal');
                    
                    // 更新预览数据
                    previewData = result.preview_data;
                    displayPreviewData(result.headers, result.preview_data);
                    
                    // 切换到标注页面
                    switchTab('annotate');
                    loadAnnotationData();
                } else {
                    showToast(result.error || '文件替换失败', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('替换文件失败:', error);
                showToast('替换文件失败，请检查网络连接', 'error');
            });
        }
        
        // 加载项目列表
        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/api/projects`);
                const projects = await response.json();
                
                const grid = document.getElementById('projectGrid');
                const createCard = grid.querySelector('.create-project-card');
                grid.innerHTML = '';
                grid.appendChild(createCard);
                
                projects.forEach(project => {
                    const projectCard = createProjectCard(project);
                    grid.appendChild(projectCard);
                });
            } catch (error) {
                console.error('加载项目失败:', error);
                alert('加载项目失败，请检查网络连接');
            }
        }
        
        // 创建项目卡片
        function createProjectCard(project) {
            const div = document.createElement('div');
            div.className = 'project-card';
            div.onclick = () => openProject(project.id);
            
            div.innerHTML = `
                <div class="project-title">${project.name}</div>
                <div class="project-description">${project.description || '暂无描述'}</div>
                <div class="project-stats">
                    <span>数据量: ${project.data_count}</span>
                    <div class="project-progress">
                        <span>${project.completion_rate}%</span>
                        <div class="progress-bar-small">
                            <div class="progress-fill-small" style="width: ${project.completion_rate}%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        // 显示创建项目模态框
        function showCreateProjectModal() {
            document.getElementById('createProjectModal').classList.add('active');
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
        }
        
        // 创建项目
        async function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            
            if (!name) {
                alert('请输入项目名称');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/projects`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    closeModal('createProjectModal');
                    loadProjects();
                    alert('项目创建成功');
                } else {
                    alert(result.error || '创建失败');
                }
            } catch (error) {
                console.error('创建项目失败:', error);
                alert('创建项目失败，请检查网络连接');
            }
        }
        
        // 打开项目
        async function openProject(projectId) {
            try {
                console.log('正在打开项目:', projectId);
                
                const response = await fetch(`${API_BASE}/api/projects/${projectId}`);
                console.log('项目响应状态:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('项目加载错误:', errorText);
                    throw new Error(`项目不存在或加载失败: ${response.status}`);
                }
                
                currentProject = await response.json();
                console.log('加载的项目数据:', currentProject);
                
                // 显示项目相关标签页
                document.getElementById('uploadTab').style.display = 'block';
                document.getElementById('annotateTab').style.display = 'block';
                document.getElementById('exportTab').style.display = 'block';
                
                // 更新页面标题
                document.querySelector('.header h1').textContent = `🎯 ${currentProject.name}`;
                
                // 检查是否已有数据
                const dataResponse = await fetch(`${API_BASE}/api/projects/${projectId}/data?page=1&per_page=1`);
                if (dataResponse.ok) {
                    const dataResult = await dataResponse.json();
                    console.log('数据检查结果:', dataResult);
                    
                    if (dataResult.data && dataResult.data.length > 0) {
                        console.log('项目已有数据，切换到标注页面');
                        switchTab('annotate');
                        loadAnnotationData();
                    } else {
                        console.log('项目无数据，切换到上传页面');
                        switchTab('upload');
                    }
                } else {
                    console.log('无法检查项目数据，切换到上传页面');
                    switchTab('upload');
                }
                
            } catch (error) {
                console.error('打开项目详细错误:', error);
                alert(`打开项目失败: ${error.message}`);
            }
        }
        
        // 切换上传方式
        function toggleUploadMethod() {
            const type = document.getElementById('uploadType').value;
            document.getElementById('fileUpload').style.display = type === 'file' ? 'block' : 'none';
            document.getElementById('urlUpload').style.display = type === 'url' ? 'block' : 'none';
            document.getElementById('ftpUpload').style.display = type === 'ftp' ? 'block' : 'none';
        }
        
        // 切换自定义分隔符
        function toggleCustomDelimiter() {
            const delimiter = document.getElementById('delimiter').value;
            document.getElementById('customDelimiterGroup').style.display = 
                delimiter === 'custom' ? 'block' : 'none';
        }
        
        // 上传数据
        async function uploadData() {
            if (!currentProject) {
                alert('请先选择项目');
                return;
            }
            
            const formData = new FormData();
            const uploadType = document.getElementById('uploadType').value;
            
            formData.append('upload_type', uploadType);
            formData.append('delimiter', document.getElementById('delimiter').value === 'custom' 
                ? document.getElementById('customDelimiter').value 
                : document.getElementById('delimiter').value);
            formData.append('encoding', document.getElementById('encoding').value);
            formData.append('has_header', document.getElementById('hasHeader').checked);
            
            if (uploadType === 'file') {
                const file = document.getElementById('dataFile').files[0];
                if (!file) {
                    alert('请选择文件');
                    return;
                }
                formData.append('file', file);
            } else if (uploadType === 'url') {
                formData.append('url', document.getElementById('dataUrl').value);
            } else if (uploadType === 'ftp') {
                formData.append('ftp_server', document.getElementById('ftpServer').value);
                formData.append('ftp_user', document.getElementById('ftpUser').value);
                formData.append('ftp_password', document.getElementById('ftpPassword').value);
                formData.append('ftp_path', document.getElementById('ftpPath').value);
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/projects/${currentProject.id}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    previewData = result.preview_data;
                    displayPreviewData(result.headers, result.preview_data);
                    showAnnotationConfigSection(result.headers);
                    alert(`上传成功！共解析 ${result.total_rows} 行数据`);
                } else {
                    alert(result.error || '上传失败');
                }
            } catch (error) {
                console.error('上传失败:', error);
                alert('上传失败，请检查网络连接');
            }
        }
        
        // 显示预览数据和列配置
        function displayPreviewData(headers, data) {
            const previewSection = document.getElementById('previewSection');
            const tableHead = document.getElementById('previewTableHead');
            const tableBody = document.getElementById('previewTableBody');
            
            previewSection.style.display = 'block';
            
            // 构建表头
            tableHead.innerHTML = `
                <tr>
                    ${headers.map(header => `
                        <th>
                            <input type="text" class="editable-header" value="${header}" 
                                   onchange="updateHeader(this, '${header}')">
                        </th>
                    `).join('')}
                </tr>
            `;
            
            // 构建数据行
            tableBody.innerHTML = data.map(row => `
                <tr>
                    ${headers.map(header => `<td>${row[header] || ''}</td>`).join('')}
                </tr>
            `).join('');
            
            // 显示列配置区域
            showColumnConfigSection(headers);
        }
        
        // 显示列配置区域
        function showColumnConfigSection(headers) {
            const configSection = document.getElementById('annotationConfigSection');
            const configsContainer = document.getElementById('annotationConfigs');
            
            // 先显示列配置
            configsContainer.innerHTML = `
                <div class="annotation-config-card">
                    <div class="config-header">
                        <div class="config-title">原始数据列配置</div>
                    </div>
                    <div class="section-title" style="font-size: 16px; margin-bottom: 15px;">配置原始数据列的显示和行为</div>
                    <div id="columnConfigList">
                        ${headers.map((header, index) => `
                            <div class="form-row" style="align-items: center; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 15px; background: #fafafa;">
                                <div class="form-group" style="margin: 0; flex: 2;">
                                    <label class="form-label" style="font-weight: 600; color: #495057;">列名: ${header}</label>
                                </div>
                                <div class="form-group" style="margin: 0; flex: 1;">
                                    <label class="form-label">列宽度 (px):</label>
                                    <input type="number" class="form-control column-width-input" id="width_${index}" 
                                           value="150" min="50" max="500" placeholder="150">
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="visible_${index}" checked>
                                    <label for="visible_${index}">显示</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="isUrl_${index}" onchange="toggleUrlOptions(${index})">
                                    <label for="isUrl_${index}">URL链接</label>
                                </div>
                                <div class="checkbox-group" id="urlOptions_${index}" style="display: none;">
                                    <input type="checkbox" id="urlNewWindow_${index}" checked>
                                    <label for="urlNewWindow_${index}">小窗口打开</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="searchable_${index}" onchange="toggleColumnSearch(${index})">
                                    <label for="searchable_${index}">启用搜索</label>
                                </div>
                                <div class="form-group" id="searchApi_${index}" style="display: none; margin-top: 10px; flex: 2;">
                                    <label class="form-label">搜索API:</label>
                                    <input type="text" class="form-control" placeholder="https://api.example.com/search">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // 然后添加标注项配置区域
            configsContainer.innerHTML += `
                <div class="annotation-config-card">
                    <div class="config-header">
                        <div class="config-title">标注项配置</div>
                        <button class="btn btn-outline" onclick="addAnnotationConfig()">➕ 添加标注项</button>
                    </div>
                    <div id="annotationConfigList"></div>
                </div>
            `;
            
            configSection.style.display = 'block';
            
            // 默认添加一个标注配置
            if (annotationConfigs.length === 0) {
                addAnnotationConfig();
            }
        }
        
        // 切换URL选项
        function toggleUrlOptions(index) {
            const urlOptions = document.getElementById(`urlOptions_${index}`);
            const isUrl = document.getElementById(`isUrl_${index}`).checked;
            urlOptions.style.display = isUrl ? 'block' : 'none';
        }
        
        // 更新表头
        function updateHeader(input, originalHeader) {
            const newHeader = input.value.trim();
            if (!newHeader) {
                alert('表头不能为空');
                input.value = originalHeader;
                return;
            }
            
            // 更新预览数据中的表头
            previewData.forEach(row => {
                if (row[originalHeader] !== undefined) {
                    row[newHeader] = row[originalHeader];
                    if (newHeader !== originalHeader) {
                        delete row[originalHeader];
                    }
                }
            });
            
            // 重新显示预览数据
            const headers = Object.keys(previewData[0] || {});
            displayPreviewData(headers, previewData);
        }
        
        // 显示标注配置区域
        function showAnnotationConfigSection(headers) {
            const section = document.getElementById('annotationConfigSection');
            section.style.display = 'block';
            
            // 默认添加一个标注配置
            if (annotationConfigs.length === 0) {
                addAnnotationConfig();
            }
        }
        
        // 添加标注配置
        function addAnnotationConfig() {
            const configId = `config_${Date.now()}`;
            const configList = document.getElementById('annotationConfigList');
            
            const configDiv = document.createElement('div');
            configDiv.className = 'annotation-config-card';
            configDiv.id = configId;
            configDiv.style.marginTop = '15px';
            configDiv.style.padding = '15px';
            configDiv.style.border = '1px solid #e9ecef';
            configDiv.style.borderRadius = '8px';
            
            configDiv.innerHTML = `
                <div class="config-header">
                    <div class="config-title">标注项 #${annotationConfigs.length + 1}</div>
                    <button class="btn btn-danger" onclick="removeAnnotationConfig('${configId}')" style="padding: 5px 10px; font-size: 12px;">删除</button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">字段名称：</label>
                        <input type="text" class="form-control" id="${configId}_fieldName" placeholder="例如：质量评分">
                    </div>
                    <div class="form-group">
                        <label class="form-label">标注提示：</label>
                        <input type="text" class="form-control" id="${configId}_labelText" placeholder="显示在输入框上方的说明文字">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">输入类型：</label>
                        <select class="form-control" id="${configId}_inputType" onchange="toggleInputTypeOptions('${configId}')">
                            <option value="text">文本输入</option>
                            <option value="number">数字输入</option>
                            <option value="select">下拉选择</option>
                        </select>
                    </div>
                    <div class="form-group" id="${configId}_numberOptions" style="display:none;">
                        <label class="form-label">数值范围：</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" class="form-control" id="${configId}_minValue" placeholder="最小值" style="flex: 1;">
                            <input type="number" class="form-control" id="${configId}_maxValue" placeholder="最大值" style="flex: 1;">
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="${configId}_selectOptions" style="display:none;">
                    <label class="form-label">选项设置（每行一个选项）：</label>
                    <textarea class="form-control" id="${configId}_options" rows="3" placeholder="选项1\n选项2\n选项3"></textarea>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="${configId}_isSearchable" onchange="toggleSearchOptions('${configId}')">
                    <label for="${configId}_isSearchable">启用搜索功能</label>
                </div>
                
                <div class="form-group" id="${configId}_searchOptions" style="display:none; margin-top: 10px;">
                    <label class="form-label">搜索API地址：</label>
                    <input type="text" class="form-control" id="${configId}_searchApi" placeholder="https://api.example.com/search">
                </div>
            `;
            
            configList.appendChild(configDiv);
            annotationConfigs.push(configId);
        }
        
        // 删除标注配置
        function removeAnnotationConfig(configId) {
            if (annotationConfigs.length <= 1) {
                alert('至少需要保留一个标注项');
                return;
            }
            
            document.getElementById(configId).remove();
            annotationConfigs = annotationConfigs.filter(id => id !== configId);
        }
        
        // 切换输入类型选项
        function toggleInputTypeOptions(configId) {
            const inputType = document.getElementById(`${configId}_inputType`).value;
            document.getElementById(`${configId}_numberOptions`).style.display = 
                inputType === 'number' ? 'block' : 'none';
            document.getElementById(`${configId}_selectOptions`).style.display = 
                inputType === 'select' ? 'block' : 'none';
        }
        
        // 切换搜索选项
        function toggleSearchOptions(configId) {
            const isSearchable = document.getElementById(`${configId}_isSearchable`).checked;
            document.getElementById(`${configId}_searchOptions`).style.display = 
                isSearchable ? 'block' : 'none';
        }
        
        // 保存标注配置
        async function saveAnnotationConfig() {
            if (!currentProject) {
                alert('请先选择项目');
                return;
            }
            
            try {
                // 获取列配置
                const headers = Object.keys(previewData[0] || {});
                const columnConfigs = headers.map((header, index) => ({
                    original_name: header,
                    display_name: header,
                    is_visible: document.getElementById(`visible_${index}`)?.checked || true,
                    is_url: document.getElementById(`isUrl_${index}`)?.checked || false,
                    url_new_window: document.getElementById(`urlNewWindow_${index}`)?.checked || true,
                    column_width: parseInt(document.getElementById(`width_${index}`)?.value) || 150,
                    is_searchable: document.getElementById(`searchable_${index}`)?.checked || false,
                    search_api: document.getElementById(`searchApi_${index}`)?.querySelector('input')?.value || ''
                }));
                
                // 获取标注配置
                const annotationConfigsList = [];
                for (const configId of annotationConfigs) {
                    const fieldName = document.getElementById(`${configId}_fieldName`)?.value.trim();
                    if (!fieldName) {
                        alert('请填写所有标注项的字段名称');
                        return;
                    }
                    
                    const config = {
                        fieldName,
                        labelText: document.getElementById(`${configId}_labelText`)?.value || '',
                        inputType: document.getElementById(`${configId}_inputType`)?.value || 'text',
                        minValue: document.getElementById(`${configId}_minValue`)?.value || '',
                        maxValue: document.getElementById(`${configId}_maxValue`)?.value || '',
                        options: document.getElementById(`${configId}_options`)?.value.split('\n').filter(opt => opt.trim()) || [],
                        isSearchable: document.getElementById(`${configId}_isSearchable`)?.checked || false,
                        searchApi: document.getElementById(`${configId}_searchApi`)?.value || ''
                    };
                    
                    annotationConfigsList.push(config);
                }
                
                console.log('保存配置:', {
                    column_configs: columnConfigs,
                    annotation_configs: annotationConfigsList
                });
                
                // 先保存列配置
                const columnResponse = await fetch(`${API_BASE}/api/projects/${currentProject.id}/columns`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ columns: columnConfigs })
                });
                
                if (!columnResponse.ok) {
                    const error = await columnResponse.json();
                    throw new Error(error.message || '列配置保存失败');
                }
                
                // 再保存标注配置
                const configResponse = await fetch(`${API_BASE}/api/projects/${currentProject.id}/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        annotation_configs: annotationConfigsList,
                        column_configs: columnConfigs
                    })
                });
                
                if (!configResponse.ok) {
                    const error = await configResponse.json();
                    throw new Error(error.message || '标注配置保存失败');
                }
                
                alert('配置保存成功');
                switchTab('annotate');
                loadAnnotationData();
                
            } catch (error) {
                console.error('保存配置失败:', error);
                alert(`保存配置失败: ${error.message}`);
            }
        }
        
        // 加载标注数据
        async function loadAnnotationData() {
            if (!currentProject) return;
            
            try {
                const response = await fetch(
                    `${API_BASE}/api/projects/${currentProject.id}/data?page=${currentPage}&per_page=${pageSize}`
                );
                
                const result = await response.json();
                
                if (response.ok) {
                    displayAnnotationTable(result.data, result.columns, result.pagination);
                    updatePaginationInfo(result.pagination);
                } else {
                    alert('加载数据失败');
                }
            } catch (error) {
                console.error('加载标注数据失败:', error);
                alert('加载数据失败，请检查网络连接');
            }
        }
        
        // 显示标注表格
        function displayAnnotationTable(data, columns, pagination) {
            const tableHead = document.getElementById('dataTableHead');
            const tableBody = document.getElementById('dataTableBody');
            
            columnConfigs = columns;
            
            // 构建表头 - 包含列宽度设置
            const headerCells = [{ name: '序号', width: 60 }];
            columns.filter(col => col.is_visible).forEach(col => {
                headerCells.push({ 
                    name: col.display_name, 
                    width: col.column_width || 150 
                });
            });
            
            // 添加标注列头
            const config = currentProject.config || {};
            const annotationConfigs = config.annotation_configs || [];
            annotationConfigs.forEach(annConfig => {
                headerCells.push({ 
                    name: annConfig.fieldName, 
                    width: 200 
                });
            });
            
            // 设置表格列宽度
            let colWidthStyle = '';
            headerCells.forEach((header, index) => {
                colWidthStyle += `.data-table th:nth-child(${index + 1}), .data-table td:nth-child(${index + 1}) { width: ${header.width}px; max-width: ${header.width}px; } `;
            });
            
            // 更新或创建样式
            let styleElement = document.getElementById('tableWidthStyles');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'tableWidthStyles';
                document.head.appendChild(styleElement);
            }
            styleElement.textContent = colWidthStyle;
            
            tableHead.innerHTML = `
                <tr>
                    ${headerCells.map(header => `<th title="${header.name}">${header.name}</th>`).join('')}
                </tr>
            `;
            
            // 构建数据行
            tableBody.innerHTML = '';
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // 序号
                tr.innerHTML += `<td>${(currentPage - 1) * pageSize + index + 1}</td>`;
                
                // 原始数据列
                columns.filter(col => col.is_visible).forEach(col => {
                    const value = row.original_data[col.original_name] || '';
                    let cellContent = '';
                    
                    // 检查是否配置为URL列
                    if (col.is_url && value && (value.startsWith('http://') || value.startsWith('https://'))) {
                        const displayUrl = truncateUrl(value, col.column_width);
                        const openMethod = col.url_new_window ? 'openUrlInPopup' : 'openUrlInTab';
                        cellContent = `<span class="url-link" onclick="${openMethod}('${value}')" title="${value}">${displayUrl}</span>`;
                    } else if (col.is_searchable && col.search_api) {
                        // 如果列配置为可搜索，添加搜索按钮
                        cellContent = `
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span title="${value}" style="flex: 1; overflow: hidden; text-overflow: ellipsis;">${value}</span>
                                <button class="btn btn-outline" onclick="searchColumnContent('${value.replace(/'/g, "&apos;")}', '${col.search_api}')" 
                                        style="padding: 2px 6px; font-size: 11px; flex-shrink: 0;">🔍</button>
                            </div>
                        `;
                    } else {
                        cellContent = `<span title="${value}">${value}</span>`;
                    }
                    
                    tr.innerHTML += `<td>${cellContent}</td>`;
                });
                
                // 标注列
                annotationConfigs.forEach(annConfig => {
                    const cellValue = row.annotations[annConfig.fieldName] || '';
                    let cellHTML = '<td>';
                    
                    if (annConfig.labelText) {
                        cellHTML += `<span class="annotation-label">${annConfig.labelText}</span>`;
                    }
                    
                    // 根据输入类型生成不同的输入框
                    if (annConfig.inputType === 'select') {
                        cellHTML += `<select class="annotation-input" onchange="saveAnnotation(${row.id}, '${annConfig.fieldName}', this.value)">`;
                        cellHTML += '<option value="">请选择</option>';
                        annConfig.options.forEach(option => {
                            cellHTML += `<option value="${option}" ${cellValue === option ? 'selected' : ''}>${option}</option>`;
                        });
                        cellHTML += '</select>';
                    } else if (annConfig.inputType === 'number') {
                        cellHTML += `<input type="number" class="annotation-input" 
                                          min="${annConfig.minValue || ''}" 
                                          max="${annConfig.maxValue || ''}"
                                          value="${cellValue}" 
                                          onchange="saveAnnotation(${row.id}, '${annConfig.fieldName}', this.value)">`;
                    } else {
                        cellHTML += `<input type="text" class="annotation-input" 
                                          value="${cellValue}" 
                                          onchange="saveAnnotation(${row.id}, '${annConfig.fieldName}', this.value)">`;
                    }
                    
                    if (annConfig.isSearchable && annConfig.searchApi) {
                        cellHTML += `<button class="btn btn-outline" onclick="searchContent(${row.id}, '${annConfig.fieldName}', '${annConfig.searchApi}')" 
                                            style="margin-left: 5px; padding: 3px 8px; font-size: 11px;">🔍</button>`;
                    }
                    
                    cellHTML += '</td>';
                    tr.innerHTML += cellHTML;
                });
                
                tableBody.appendChild(tr);
            });
        }
        
        // 截断URL显示
        function truncateUrl(url, maxWidth) {
            const avgCharWidth = 8; // 估算字符宽度
            const maxChars = Math.floor((maxWidth - 40) / avgCharWidth); // 40px留给其他元素
            
            if (url.length <= maxChars) {
                return url;
            }
            
            // 保留协议和域名，截断路径部分
            const urlParts = url.match(/^(https?:\/\/[^\/]+)(.*)/);
            if (urlParts && urlParts[1].length < maxChars - 10) {
                const domain = urlParts[1];
                const path = urlParts[2];
                const remainingChars = maxChars - domain.length - 3; // 3 for "..."
                if (remainingChars > 0) {
                    return domain + '...' + path.slice(-remainingChars);
                }
            }
            
            // 如果域名太长，直接截断
            return url.slice(0, maxChars - 3) + '...';
        }
        
        // 在小窗口中打开URL
        function openUrlInPopup(url) {
            const popup = window.open(
                url,
                'urlPopup',
                'width=1000,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no'
            );
            
            if (popup) {
                popup.focus();
            } else {
                alert('弹窗被阻止，请检查浏览器设置或直接访问：\n' + url);
            }
        }
        
        // 在新标签页中打开URL
        function openUrlInTab(url) {
            window.open(url, '_blank');
        }
        
        // 切换列搜索选项
        function toggleColumnSearch(index) {
            const searchConfig = document.getElementById(`searchApi_${index}`);
            const isSearchable = document.getElementById(`searchable_${index}`).checked;
            searchConfig.style.display = isSearchable ? 'block' : 'none';
        }
        async function searchColumnContent(searchText, searchApi) {
            if (!searchApi) {
                alert('未配置搜索API');
                return;
            }
            
            const modal = document.getElementById('searchModal');
            const resultsDiv = document.getElementById('searchResults');
            
            resultsDiv.innerHTML = '<p>正在搜索...</p>';
            modal.classList.add('active');
            
            try {
                const response = await fetch(`${API_BASE}/api/projects/${currentProject.id}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        search_text: searchText,
                        search_api: searchApi
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.results) {
                    let html = `<h4>搜索关键词: ${searchText}</h4>`;
                    html += '<div style="margin-top: 15px;">';
                    
                    if (result.results.items) {
                        result.results.items.forEach((item, index) => {
                            html += `<div style="padding: 10px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 10px;">
                                <strong>结果 ${index + 1}:</strong> ${item.title || ''}
                                <br><small>${item.snippet || ''}</small>
                            </div>`;
                        });
                    }
                    
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<p>搜索失败或无结果</p>';
                }
            } catch (error) {
                console.error('搜索失败:', error);
                resultsDiv.innerHTML = '<p>搜索请求失败</p>';
            }
        }
        
        // 保存标注
        async function saveAnnotation(rowId, fieldName, value) {
            if (!currentProject) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/projects/${currentProject.id}/annotations`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        row_id: rowId,
                        annotations: { [fieldName]: value }
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(error.message || '保存失败');
                }
            } catch (error) {
                console.error('保存标注失败:', error);
            }
        }
        
        // 搜索内容
        async function searchContent(rowId, fieldName, searchApi) {
            if (!searchApi) {
                alert('未配置搜索API');
                return;
            }
            
            const modal = document.getElementById('searchModal');
            const resultsDiv = document.getElementById('searchResults');
            
            resultsDiv.innerHTML = '<p>正在搜索...</p>';
            modal.classList.add('active');
            
            try {
                const response = await fetch(`${API_BASE}/api/projects/${currentProject.id}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        search_text: 'search query',
                        search_api: searchApi
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.results) {
                    let html = `<h4>搜索关键词: ${result.search_text}</h4>`;
                    html += '<div style="margin-top: 15px;">';
                    
                    if (result.results.items) {
                        result.results.items.forEach((item, index) => {
                            html += `<p><strong>搜索结果 ${index + 1}:</strong> ${item.snippet || item.title}</p>`;
                        });
                    }
                    
                    html += '</div>';
                    html += `<div style="margin-top: 20px;">
                        <label class="form-label">基于搜索结果的建议：</label>
                        <input type="text" class="form-control" placeholder="输入标注值" 
                               onkeypress="if(event.key==='Enter') applySearchResult(${rowId}, '${fieldName}', this.value)">
                        <button class="btn btn-primary" onclick="applySearchResult(${rowId}, '${fieldName}', this.previousElementSibling.value)" 
                                style="margin-top: 10px;">应用</button>
                    </div>`;
                    
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<p>搜索失败或无结果</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<p>搜索请求失败</p>';
            }
        }
        
        // 应用搜索结果
        function applySearchResult(rowId, fieldName, value) {
            if (value) {
                const input = document.querySelector(`input[onchange*="${rowId}"][onchange*="${fieldName}"]`);
                if (input) {
                    input.value = value;
                    saveAnnotation(rowId, fieldName, value);
                }
                closeModal('searchModal');
            }
        }
        
        // 更新分页信息
        function updatePaginationInfo(pagination) {
            currentPage = pagination.page;
            totalPages = pagination.pages;
            
            document.getElementById('paginationInfo').textContent = 
                `第 ${currentPage} 页，共 ${totalPages} 页 (总计 ${pagination.total} 条)`;
        }
        
        // 改变每页大小
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            loadAnnotationData();
        }
        
        // 上一页
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadAnnotationData();
            }
        }
        
        // 下一页
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadAnnotationData();
            }
        }
        
        // 加载统计信息
        async function loadStatistics() {
            if (!currentProject) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/projects/${currentProject.id}/statistics`);
                const stats = await response.json();
                
                if (response.ok) {
                    displayStatistics(stats);
                }
            } catch (error) {
                console.error('加载统计信息失败:', error);
            }
        }
        
        // 显示统计信息
        function displayStatistics(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">总数据量</div>
                    <div class="stat-value">${stats.total_count}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">已标注</div>
                    <div class="stat-value">${stats.annotated_count}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">完成率</div>
                    <div class="stat-value">${stats.completion_rate}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">平均评分</div>
                    <div class="stat-value">${stats.avg_rating || '-'}</div>
                </div>
            `;
        }
        
        // 导出数据
        async function exportData() {
            if (!currentProject) return;
            
            const format = document.getElementById('exportFormat').value;
            const includeOriginal = document.getElementById('includeOriginal').checked;
            const includeAnnotations = document.getElementById('includeAnnotations').checked;
            const includeStats = document.getElementById('includeStats').checked;
            
            try {
                const response = await fetch(`${API_BASE}/api/projects/${currentProject.id}/export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        format,
                        include_original: includeOriginal,
                        include_annotations: includeAnnotations,
                        include_stats: includeStats
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `${currentProject.name}_export.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('导出成功！');
                } else {
                    const error = await response.json();
                    alert(error.message || '导出失败');
                }
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败，请检查网络连接');
            }
        }
        
        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // 点击模态框背景关闭
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>